<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trox — فضاء الكبسولات</title>
<meta name="description" content="فضاء تفاعلي لعرض كبسولات خالدة — Trox">
<style>
  :root{
    --accent:#00d4ff; --accent2:#9b6aff; --muted:#9fb0c7;
  }
  html,body{height:100%;margin:0;background:#000;font-family:"Cairo",sans-serif;color:#eaffff;overflow:hidden}
  #canvas-wrap{position:fixed;inset:0;z-index:0}
  /* top UI */
  #topbar{position:fixed;left:12px;right:12px;top:12px;z-index:60;display:flex;justify-content:space-between;pointer-events:none}
  .logo{pointer-events:auto;display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .mark{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#001;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .actions{display:flex;gap:10px;pointer-events:auto}
  .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001}
  #plock{position:fixed;left:50%;top:84px;transform:translateX(-50%);z-index:55;background:rgba(0,0,0,0.45);color:var(--muted);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);pointer-events:auto}

  /* overlay */
  #overlay{position:fixed;right:50%;top:52%;transform:translate(50%,-50%);z-index:70;min-width:320px;max-width:760px;background:linear-gradient(180deg,rgba(4,8,15,0.98),rgba(2,4,10,0.98));color:#eaffff;border-radius:14px;padding:18px;border:1px solid rgba(0,220,255,0.12);box-shadow:0 20px 60px rgba(0,0,0,0.7);display:none}
  #overlay h3{margin:0 0 8px;color:var(--accent)} #overlay .meta{color:var(--muted);font-size:0.9rem;margin-bottom:10px} #overlay p{white-space:pre-wrap}
  #overlay .controls{margin-top:12px;display:flex;justify-content:flex-end}
  #overlay button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  #overlay .close{background:var(--accent);color:#001}

  /* login modal (simple) */
  #loginModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:80;background:linear-gradient(180deg,rgba(5,8,12,0.98),rgba(2,3,6,0.98));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);display:none;min-width:320px}
  #loginModal label{display:block;margin-top:8px;color:var(--muted);font-size:0.9rem}
  #loginModal input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-top:6px;box-sizing:border-box}
  #loginModal .row{display:flex;gap:8px;margin-top:10px}
  #legend{position:fixed;left:12px;bottom:12px;z-index:60;color:var(--muted);background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
  @media(max-width:760px){ #overlay{right:8px;left:8px;transform:none;top:55%} #plock{top:110px} }
</style>
</head>
<body>
  <div id="canvas-wrap"></div>

  <div id="topbar">
    <div class="logo">
      <div class="mark">TRX</div>
      <div>
        <div style="font-size:12px;color:var(--muted)">مشروع تجريبي</div>
        <div style="font-weight:800">Trox — الكبسولة الخالدة</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="openLogin">🔐 تسجيل / دخول</button>
      <button class="btn primary" id="openCreate">🚀 أطلق كبسولتك</button>
    </div>
  </div>

  <div id="plock">انقر داخل المشهد ثم حرّك الماوس أو المس الشاشة للتحكم</div>

  <div id="overlay" role="dialog" aria-modal="true">
    <h3 id="ovTitle">عنوان الكبسولة</h3>
    <div class="meta" id="ovMeta">المرسل • الرتبة • التاريخ</div>
    <p id="ovBody">نص الكبسولة...</p>
    <div class="controls"><button class="close" id="ovClose">إغلاق</button></div>
  </div>

  <div id="loginModal" role="dialog" aria-modal="true">
    <h3>تسجيل / تسجيل دخول</h3>
    <label>البريد الإلكتروني</label>
    <input id="email" type="email" placeholder="you@example.com" />
    <label>كلمة المرور</label>
    <input id="password" type="password" placeholder="••••••••" />
    <div class="row">
      <button class="btn" id="btnRegister">إنشاء حساب</button>
      <button class="btn" id="btnSignIn">تسجيل الدخول</button>
    </div>
    <div style="margin-top:8px;color:var(--muted);font-size:0.9rem">سجل لحفظ كبسولاتك وإطلاق كبسولات خاصة.</div>
  </div>

  <div id="legend">اسحب/حرك لتدوير المشهد — اضغط/المس لفتح كبسولة</div>

  <!-- Module script -->
  <script type="module">
  import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
  import { OrbitControls } from 'https://unpkg.com/three@0.154.0/examples/jsm/controls/OrbitControls.js';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  // ---------- CONFIG ----------
  const FIREBASE_ENABLED = true; // اضبط false للاختبار المحلي دون Firestore/Auth
  const firebaseConfig = {
    apiKey: "AIzaSyCR8AiukqMEGOFDsjhv7tsFFFLDM5gWpu4",
    authDomain: "trox-capsules.firebaseapp.com",
    projectId: "trox-capsules",
    storageBucket: "trox-capsules.firebasestorage.app",
    messagingSenderId: "104606988275",
    appId: "1:104606988275:web:24d2a719dd863357660486",
    measurementId: "G-MEKWLRWGDS"
  };

  // ---------- DOM ----------
  const container = document.getElementById('canvas-wrap');
  const overlay = document.getElementById('overlay');
  const ovTitle = document.getElementById('ovTitle'), ovMeta = document.getElementById('ovMeta'), ovBody = document.getElementById('ovBody');
  const ovClose = document.getElementById('ovClose');
  const loginModal = document.getElementById('loginModal');
  const openLoginBtn = document.getElementById('openLogin');
  const openCreateBtn = document.getElementById('openCreate');
  const btnRegister = document.getElementById('btnRegister'), btnSignIn = document.getElementById('btnSignIn');

  // ---------- THREE scene ----------
  let renderer, scene, camera, controls, raycaster;
  const capsuleEntries = new Map(); // id -> {mesh, data}
  const transientParticles = [];
  let mouse = new THREE.Vector2();
  let prevTime = performance.now();

  init();
  animate();

  function init(){
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    container.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000010);
    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 5000);
    camera.position.set(0,8,28);

    // lights
    const hemi = new THREE.HemisphereLight(0x8899ff, 0x080820, 0.6); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(10,20,10); scene.add(dir);
    const glow = new THREE.PointLight(0x00d4ff, 0.12, 200); scene.add(glow);
    scene.fog = new THREE.FogExp2(0x000018, 0.0012);

    // starfield
    const starCount = 1000;
    const pos = new Float32Array(starCount*3);
    for(let i=0;i<starCount;i++){
      pos[i*3] = (Math.random()-0.5)*2000;
      pos[i*3+1] = (Math.random()-0.5)*2000;
      pos[i*3+2] = (Math.random()-0.5)*2000;
    }
    const starsGeo = new THREE.BufferGeometry(); starsGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const starsMat = new THREE.PointsMaterial({ color:0xbfefff, size:0.8, transparent:true, opacity:0.75 });
    const stars = new THREE.Points(starsGeo, starsMat); scene.add(stars);

    // controls
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.08;
    controls.rotateSpeed = 0.5; controls.panSpeed = 0.4; controls.zoomSpeed = 0.9;
    controls.minDistance = 6; controls.maxDistance = 120;

    raycaster = new THREE.Raycaster();

    // events
    window.addEventListener('resize', onResize);
    renderer.domElement.addEventListener('pointerdown', onPointerDown, { passive:false });
    renderer.domElement.addEventListener('touchstart', onPointerDown, { passive:false });
    ovClose.addEventListener('click', hideOverlay);
    openLoginBtn.addEventListener('click', showLogin);
    openCreateBtn.addEventListener('click', ()=> location.href='كبسولة.html');

    // Firebase
    if(FIREBASE_ENABLED){
      try {
        initializeApp(firebaseConfig);
        const db = getFirestore();
        const auth = getAuth();
        onAuthStateChanged(auth, user => {
          openLoginBtn.textContent = user ? 'حسابك ✓' : '🔐 تسجيل / دخول';
        });
        const q = query(collection(db,'capsules'), orderBy('ts','desc'));
        onSnapshot(q, snap => {
          snap.docChanges().forEach(ch=>{
            const id = ch.doc.id; const data = ch.doc.data();
            if(data.ts && data.ts.seconds) data.ts = data.ts.seconds * 1000;
            if(ch.type==='added') addCapsuleEntry(id, data);
            if(ch.type==='modified') updateCapsuleEntry(id, data);
            if(ch.type==='removed') removeCapsuleEntry(id);
          });
        }, err => { console.error('snapshot err',err); setTimeout(createDemoCapsules,200); });
      } catch(e){
        console.error('firebase init error', e); setTimeout(createDemoCapsules,200);
      }
    } else {
      createDemoCapsules();
    }
  }

  // ---------- create capsule mesh ----------
  function createCapsuleMesh(data){
    let rank = (data && data.rank) ? data.rank.toString().toLowerCase() : 'common';
    let col = 0x44b3ff, trim = 0x0b3a55;
    if(rank.includes('special')||rank.includes('خاصة')){ col=0xb36aff; trim=0x2b0f3a; }
    if(rank.includes('legend')||rank.includes('خالدة')||rank.includes('legendary')){ col=0xffd166; trim=0x3a2a00; }

    // hex prism
    const geom = new THREE.CylinderGeometry(1.2,1.2,1.8,6,1,false); geom.rotateX(Math.PI/2);
    const mat = new THREE.MeshStandardMaterial({ color: col, metalness:0.85, roughness:0.25, emissive:0x000000, emissiveIntensity:0.4 });
    const prism = new THREE.Mesh(geom, mat);

    // edges
    const edges = new THREE.LineSegments(new THREE.EdgesGeometry(geom), new THREE.LineBasicMaterial({ color:0x000000, transparent:true, opacity:0.12 }));

    // plate (pattern)
    const canvas = document.createElement('canvas'); canvas.width=256; canvas.height=256;
    const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,256,256); ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=2;
    for(let i=0;i<6;i++){ ctx.strokeRect(18+i*8,18+i*8,220-i*16,220-i*16); }
    const tex = new THREE.CanvasTexture(canvas); tex.encoding = THREE.sRGBEncoding;
    const plate = new THREE.Mesh(new THREE.CircleGeometry(0.5,32), new THREE.MeshStandardMaterial({ map:tex, metalness:0.6, roughness:0.25, color:0x001833, emissive:0x002233, emissiveIntensity:0.12, side:THREE.DoubleSide }));
    plate.position.set(0,0,0.95); plate.rotateX(Math.PI/2);

    // glow plane
    const glow = new THREE.Mesh(new THREE.PlaneGeometry(2.6,2.6), new THREE.MeshBasicMaterial({ color: col, transparent:true, opacity:0.06, blending:THREE.AdditiveBlending }));
    glow.position.set(0,0,-0.2);

    // group
    const group = new THREE.Group(); group.add(prism); group.add(edges); group.add(plate); group.add(glow);
    group.userData = { data:data||{}, isOpen:false, baseMat: mat }; return group;
  }

  function addCapsuleEntry(id, data){
    if(capsuleEntries.has(id)) return;
    const mesh = createCapsuleMesh(data);
    mesh.position.copy(randomPosition(160));
    mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
    mesh.scale.setScalar(THREE.MathUtils.lerp(0.9,1.6,Math.random()));
    scene.add(mesh); capsuleEntries.set(id, { id, mesh, data });
  }

  function updateCapsuleEntry(id, data){
    const entry = capsuleEntries.get(id); if(!entry){ addCapsuleEntry(id,data); return; }
    entry.data = data; entry.mesh.userData.data = data;
  }
  function removeCapsuleEntry(id){ const entry = capsuleEntries.get(id); if(!entry) return; scene.remove(entry.mesh); capsuleEntries.delete(id); }

  function createDemoCapsules(){
    for(let i=0;i<28;i++){
      const rank = (i%7===0) ? 'legend' : (i%3===0)? 'special': 'common';
      const data = { title:`كبسولة #${i+1}`, message:`هذه رسالة تجريبية للكبسولة ${i+1} — مرحبًا بك في Trox!`, username:`User${i+1}`, rank, ts: Date.now() - i*100000 };
      addCapsuleEntry('demo-'+i, data);
    }
  }

  function randomPosition(radius=150){
    const u=Math.random(), v=Math.random(); const theta=2*Math.PI*u; const phi=Math.acos(2*v-1);
    const r=Math.cbrt(Math.random())*radius; const x=r*Math.sin(phi)*Math.cos(theta), y=r*Math.sin(phi)*Math.sin(theta), z=r*Math.cos(phi);
    return new THREE.Vector3(x,y,z);
  }

  // ---------- interaction & split-open effect ----------
  function onPointerDown(ev){
    ev.preventDefault();
    const rect = renderer.domElement.getBoundingClientRect();
    const clientX = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX);
    const clientY = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY);
    if(clientX===undefined) return;
    const x = ((clientX-rect.left)/rect.width)*2 - 1;
    const y = -((clientY-rect.top)/rect.height)*2 + 1;
    mouse.set(x,y); raycaster.setFromCamera(mouse,camera);
    const objs=[]; capsuleEntries.forEach(v=> objs.push(v.mesh));
    const hits = raycaster.intersectObjects(objs, true);
    if(hits.length>0){
      let obj=hits[0].object;
      while(obj && !Array.from(capsuleEntries.values()).some(v=>v.mesh===obj)) obj = obj.parent;
      const entry = Array.from(capsuleEntries.values()).find(v=>v.mesh===obj);
      if(entry) splitOpenCapsule(entry);
    }
  }

  // small WebAudio click (soft) — no external files
  function playOpenSound(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = 420; g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.08, now+0.02);
      o.start(now); o.frequency.exponentialRampToValueAtTime(220, now+0.18);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
      setTimeout(()=>{ o.stop(); ctx.close(); }, 700);
    }catch(e){}
  }

  // split open: create two halves, animate apart, particles, overlay
  function splitOpenCapsule(entry){
    const g = entry.mesh; if(g.userData.isOpen) return; g.userData.isOpen = true;
    const baseMat = g.userData.baseMat;

    // create two clones that will be the halves
    const left = g.clone(); const right = g.clone();
    // center clones on same world transform
    left.position.copy(g.position); left.quaternion.copy(g.quaternion); left.scale.copy(g.scale);
    right.position.copy(g.position); right.quaternion.copy(g.quaternion); right.scale.copy(g.scale);
    scene.add(left); scene.add(right);

    // hide original
    scene.remove(g);

    // play sound
    playOpenSound();

    // particle flash
    particleFlash(left.position, 32, entry.data && entry.data.rank);

    // animate halves: move outward + rotate
    const start = performance.now(); const duration = 420;
    function animateSplit(t){
      const p = Math.min(1,(t-start)/duration); const ease = 1 - Math.pow(1-p,3);
      // compute separation vector along local X axis of capsule (right direction)
      const sep = new THREE.Vector3(1,0,0).applyQuaternion(left.quaternion).multiplyScalar(2.4 * ease * (1+ (left.scale.x-1)*0.35));
      // left moves negative, right moves positive
      left.position.copy(g.position).add(sep.clone().multiplyScalar(-1));
      right.position.copy(g.position).add(sep.clone());
      left.rotation.x += 0.02 * (1+ease); right.rotation.x -= 0.02*(1+ease);
      // emissive flash
      left.children[0].material.emissiveIntensity = 0.8 * ease;
      right.children[0].material.emissiveIntensity = 0.8 * ease;
      if(p<1) requestAnimationFrame(animateSplit);
      else {
        // show overlay
        showOverlay(entry);
        // auto close and reassemble after 5s
        setTimeout(()=> {
          // animate reassemble
          const start2 = performance.now(), dur2 = 400;
          function reassemble(t2){
            const q = Math.min(1,(t2-start2)/dur2); const e2 = 1 - Math.pow(1-q,3);
            const sepNow = sep.clone().multiplyScalar(1-e2);
            left.position.copy(g.position).add(sepNow.clone().multiplyScalar(-1));
            right.position.copy(g.position).add(sepNow);
            left.children[0].material.emissiveIntensity = 0.8*(1-e2);
            right.children[0].material.emissiveIntensity = 0.8*(1-e2);
            if(q<1) requestAnimationFrame(reassemble);
            else {
              // remove halves and re-add original (reset)
              scene.remove(left); scene.remove(right);
              g.userData.isOpen = false;
              // reset material emissive
              if(g.userData.baseMat) g.userData.baseMat.emissiveIntensity = 0.12;
              scene.add(g);
              hideOverlay();
            }
          }
          requestAnimationFrame(reassemble);
        }, 5000);
      }
    }
    requestAnimationFrame(animateSplit);
  }

  // particles used in flash + update loop
  function particleFlash(center, amount=20, rank){
    for(let i=0;i<amount;i++){
      const geom = new THREE.SphereGeometry(0.04 + Math.random()*0.12, 6,6);
      const color = (rank && rank.toString().toLowerCase().includes('legend')) ? 0xffd166 : (rank && rank.toString().toLowerCase().includes('special') ? 0xb36aff : 0x44b3ff);
      const mat = new THREE.MeshBasicMaterial({ color, transparent:true, opacity:1, blending: THREE.AdditiveBlending });
      const p = new THREE.Mesh(geom, mat);
      p.position.copy(center);
      p.userData = { vel: new THREE.Vector3((Math.random()-0.5)*2.2, (Math.random()-0.5)*2.2, (Math.random()-0.5)*2.2), life:0 };
      scene.add(p); transientParticles.push(p);
    }
  }

  function updateParticles(dt){
    for(let i=transientParticles.length-1;i>=0;i--){
      const p = transientParticles[i]; p.position.addScaledVector(p.userData.vel, dt);
      p.userData.life += dt;
      p.material.opacity = Math.max(0, 1 - p.userData.life*1.3);
      if(p.userData.life>1.2){ scene.remove(p); transientParticles.splice(i,1); }
    }
  }

  function showOverlay(entry){
    const d = entry.data || entry.mesh.userData.data || {};
    ovTitle.textContent = d.title || 'كبسولة خالدة';
    const dateStr = d.ts ? new Date(d.ts).toLocaleString('ar-EG') : '';
    ovMeta.textContent = `${d.username||'مجهول'} • ${d.rank||'عادية'} • ${dateStr}`;
    ovBody.textContent = d.message || 'لا توجد رسالة';
    overlay.style.display = 'block';
  }
  function hideOverlay(){ overlay.style.display = 'none'; }

  // ---------- animation loop ----------
  function animate(){
    requestAnimationFrame(animate);
    const now = performance.now(); const dt = (now - prevTime)/1000; prevTime = now;

    capsuleEntries.forEach(entry=>{
      const m = entry.mesh;
      m.userData._float = m.userData._float || { t: Math.random()*100 };
      m.userData._float.t += dt * 0.45 * (0.6 + (m.scale.x-1)*0.3);
      m.position.y += Math.sin(m.userData._float.t) * 0.02;
      m.rotation.y += 0.0012 * (0.8 + (m.scale.x-1)*0.6);
    });

    updateParticles(dt);
    controls.update();
    renderer.render(scene, camera);
  }

  function onResize(){ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

  // pointer binding
  function onPointerDownWrapper(e){ onPointerDown(e); }
  renderer && renderer.domElement && renderer.domElement.addEventListener('pointerdown', onPointerDownWrapper, {passive:false});

  // ---------- Auth UI (simple) ----------
  openLoginBtn.addEventListener('click', ()=> { loginModal.style.display = 'block'; });
  document.getElementById('ovClose').addEventListener('click', hideOverlay);
  btnRegister.addEventListener('click', async ()=>{
    if(!FIREBASE_ENABLED){ alert('Firebase غير مفعل الآن'); return; }
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    if(!email || !pass){ alert('املأ البريد وكلمة المرور'); return; }
    try { const auth = getAuth(); await createUserWithEmailAndPassword(auth, email, pass); alert('تم إنشاء الحساب'); loginModal.style.display='none'; }
    catch(err){ alert('خطأ: '+err.message); }
  });
  btnSignIn.addEventListener('click', async ()=>{
    if(!FIREBASE_ENABLED){ alert('Firebase غير مفعل الآن'); return; }
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    if(!email || !pass){ alert('املأ البريد وكلمة المرور'); return; }
    try { const auth = getAuth(); await signInWithEmailAndPassword(auth, email, pass); alert('تم تسجيل الدخول'); loginModal.style.display='none'; }
    catch(err){ alert('خطأ: '+err.message); }
  });

  // cleanup on unload
  window.addEventListener('beforeunload', ()=>{ try{ renderer.dispose(); }catch(e){} });

  </script>
</body>
</html>
