<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trox â€” ÙØ¶Ø§Ø¡ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø§Øª Ø§Ù„Ø®Ø§Ù„Ø¯Ø©</title>
<meta name="description" content="Trox â€” ÙØ¶Ø§Ø¡ ØªÙØ§Ø¹Ù„ÙŠ Ù„Ø¹Ø±Ø¶ ÙƒØ¨Ø³ÙˆÙ„Ø§Øª Ø®Ø§Ù„Ø¯Ø©ØŒ Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±.">
<style>
:root{
  --accent:#00d4ff; --accent2:#9b6aff; --muted:#9fb0c7; --bg:#000010;
  --glass: rgba(255,255,255,0.03);
  --ui-pad: 10px;
  font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#000010,#000);color:#eaf6ff;overflow:hidden;-webkit-font-smoothing:antialiased}
#canvas-wrap{position:fixed;inset:0;z-index:0;background:var(--bg)}
/* TOP BAR */
#topbar{position:fixed;left:12px;right:12px;top:12px;z-index:80;display:flex;justify-content:space-between;align-items:center;gap:12px;pointer-events:none}
.brand{display:flex;gap:10px;align-items:center;pointer-events:auto}
.mark{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#001;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.brand .label{line-height:1}
.actions{display:flex;gap:8px;pointer-events:auto}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:var(--accent);font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001;box-shadow:0 10px 30px rgba(110,231,255,0.06)}

/* Pointer hint */
#hint{position:fixed;left:50%;top:86px;transform:translateX(-50%);z-index:78;background:rgba(0,0,0,0.45);color:var(--muted);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:600;pointer-events:auto}

/* Overlay message */
#overlay{position:fixed;right:50%;top:52%;transform:translate(50%,-50%);z-index:200;min-width:320px;max-width:760px;background:linear-gradient(180deg,rgba(4,8,15,0.98),rgba(2,4,10,0.98));color:#eaffff;border-radius:14px;padding:18px;border:1px solid rgba(0,220,255,0.12);box-shadow:0 24px 60px rgba(0,0,0,0.7);display:none}
#overlay h3{margin:0 0 8px;color:var(--accent)}
#overlay .meta{color:var(--muted);font-size:0.9rem;margin-bottom:10px}
#overlay p{margin:0;white-space:pre-wrap;line-height:1.6}
#overlay .controls{margin-top:12px;display:flex;justify-content:flex-end}
#overlay button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
#overlay .close{background:var(--accent);color:#001}

/* Login modal (simple) */
#loginModal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:210;background:linear-gradient(180deg,rgba(5,8,12,0.98),rgba(2,3,6,0.98));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);display:none;min-width:320px}
#loginModal label{display:block;margin-top:8px;color:var(--muted);font-size:0.9rem}
#loginModal input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-top:6px;box-sizing:border-box}
#loginModal .row{display:flex;gap:8px;margin-top:10px}

/* Legend */
#legend{position:fixed;left:12px;bottom:12px;z-index:80;color:var(--muted);background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}

/* responsive adjustments */
@media (max-width:800px){
  .mark{width:40px;height:40px}
  #overlay{right:8px;left:8px;transform:none;top:52%}
  #hint{top:110px;font-size:13px}
}
</style>
</head>
<body>
  <div id="canvas-wrap" aria-hidden="true"></div>

  <div id="topbar" role="navigation" aria-label="Ù†Ø§Ù Ø¨Ø§Ø±">
    <div class="brand">
      <div class="mark" aria-hidden="true">TRX</div>
      <div class="label">
        <div style="font-size:12px;color:var(--muted)">Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ</div>
        <div style="font-weight:800">Trox â€” Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø®Ø§Ù„Ø¯Ø©</div>
      </div>
    </div>
    <div class="actions">
      <button id="openLogin" class="btn">ğŸ” ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
      <button id="openCreate" class="btn primary">ğŸš€ Ø£Ø·Ù„Ù‚ ÙƒØ¨Ø³ÙˆÙ„ØªÙƒ</button>
    </div>
  </div>

  <div id="hint">Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø´Ù‡Ø¯ â€” Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ÙƒØ¨Ø³ÙˆÙ„Ø© Ù„ÙØªØ­ Ø±Ø³Ø§Ù„ØªÙ‡Ø§</div>
  <div id="overlay" role="dialog" aria-modal="true">
    <h3 id="ovTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©</h3>
    <div class="meta" id="ovMeta">Ø§Ù„Ù…Ø±Ø³Ù„ â€¢ Ø§Ù„Ø±ØªØ¨Ø© â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
    <p id="ovBody">Ù†Øµ Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©...</p>
    <div class="controls"><button id="ovClose" class="close">Ø¥ØºÙ„Ø§Ù‚</button></div>
  </div>

  <div id="loginModal" role="dialog" aria-modal="true">
    <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h3>
    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input id="email" type="email" placeholder="you@example.com" />
    <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    <div class="row">
      <button id="btnRegister" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <button id="btnSignIn" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div style="margin-top:8px;color:var(--muted);font-size:0.9rem">Ø³Ø¬Ù„ Ù„Ø­ÙØ¸ ÙƒØ¨Ø³ÙˆÙ„Ø§ØªÙƒ ÙˆØ¥Ø·Ù„Ø§Ù‚ ÙƒØ¨Ø³ÙˆÙ„Ø§Øª Ø®Ø§ØµØ©.</div>
  </div>

  <div id="legend">Ù…ØªØ­ÙƒÙ…: Ø§Ø³Ø­Ø¨/Ù„Ù…Ø³ Ù„Ù„ØªØ¯ÙˆÙŠØ± â€¢ Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© â€¢ Ù‚Ø±Øµ Ù„Ù„Ø¹Ø¬Ù„Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ±</div>

  <!-- Module script -->
  <script type="module">
  // ---------- IMPORTS ----------
  import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
  import { OrbitControls } from 'https://unpkg.com/three@0.154.0/examples/jsm/controls/OrbitControls.js';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  // ---------- CONFIG ----------
  const FIREBASE_ENABLED = true; // Ø¶Ø¹ false Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCR8AiukqMEGOFDsjhv7tsFFFLDM5gWpu4",
    authDomain: "trox-capsules.firebaseapp.com",
    projectId: "trox-capsules",
    storageBucket: "trox-capsules.firebasestorage.app",
    messagingSenderId: "104606988275",
    appId: "1:104606988275:web:24d2a719dd863357660486",
    measurementId: "G-MEKWLRWGDS"
  };

  // ---------- DOM ----------
  const container = document.getElementById('canvas-wrap');
  const overlay = document.getElementById('overlay');
  const ovTitle = document.getElementById('ovTitle'), ovMeta = document.getElementById('ovMeta'), ovBody = document.getElementById('ovBody');
  const ovClose = document.getElementById('ovClose');
  const loginModal = document.getElementById('loginModal');
  const openLoginBtn = document.getElementById('openLogin');
  const openCreateBtn = document.getElementById('openCreate');
  const btnRegister = document.getElementById('btnRegister'), btnSignIn = document.getElementById('btnSignIn');

  // ---------- RUNTIME ----------
  let renderer, scene, camera, controls, raycaster;
  const capsuleEntries = new Map(); // id => {mesh, data}
  const transientParticles = [];
  let mouse = new THREE.Vector2();
  let prevTime = performance.now();

  init();
  animate();

  // ---------- helpers ----------
  function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 760; }

  function init(){
    // renderer (adaptive)
    const pixelRatio = Math.min(window.devicePixelRatio || 1, 2);
    renderer = new THREE.WebGLRenderer({ antialias: !isMobile(), alpha: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(pixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    container.appendChild(renderer.domElement);

    // scene & camera
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x000010);
    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 5000);
    camera.position.set(0, 8, isMobile() ? 36 : 28);

    // lights
    const hemi = new THREE.HemisphereLight(0x8899ff, 0x080820, 0.6); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(10,20,10); scene.add(dir);
    const glow = new THREE.PointLight(0x00d4ff, 0.12, 200); scene.add(glow);

    // fog
    scene.fog = new THREE.FogExp2(0x000018, 0.0012);

    // starfield (reduced on mobile)
    const starCount = isMobile() ? 600 : 1200;
    const positions = new Float32Array(starCount*3);
    for(let i=0;i<starCount;i++){
      positions[i*3] = (Math.random()-0.5)*2000;
      positions[i*3+1] = (Math.random()-0.5)*2000;
      positions[i*3+2] = (Math.random()-0.5)*2000;
    }
    const starsGeo = new THREE.BufferGeometry(); starsGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
    const starsMat = new THREE.PointsMaterial({ color:0xbfefff, size: isMobile()?0.9:0.8, transparent:true, opacity:0.75 });
    const stars = new THREE.Points(starsGeo, starsMat); scene.add(stars);

    // controls (OrbitControls tuned for mobile)
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.09;
    controls.rotateSpeed = isMobile()?0.35:0.6; controls.panSpeed = 0.5; controls.zoomSpeed = 0.9;
    controls.minDistance = 6; controls.maxDistance = 220;
    controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

    // raycaster
    raycaster = new THREE.Raycaster();

    // events
    window.addEventListener('resize', onResize);
    renderer.domElement.addEventListener('pointerdown', onPointerDown, {passive:false});
    renderer.domElement.addEventListener('touchstart', onPointerDown, {passive:false});
    ovClose.addEventListener('click', hideOverlay);
    openLoginBtn.addEventListener('click', ()=> loginModal.style.display = 'block');
    openCreateBtn.addEventListener('click', ()=> location.href='ÙƒØ¨Ø³ÙˆÙ„Ø©.html');

    // Firebase init and realtime
    if(FIREBASE_ENABLED){
      try {
        initializeApp(firebaseConfig);
        const db = getFirestore();
        const auth = getAuth();
        onAuthStateChanged(auth, user=> openLoginBtn.textContent = user ? 'Ø­Ø³Ø§Ø¨Ùƒ âœ“' : 'ğŸ” ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„');
        // listen capsules
        const q = query(collection(db,'capsules'), orderBy('ts','desc'));
        onSnapshot(q, snap=>{
          snap.docChanges().forEach(ch=>{
            const id = ch.doc.id; const data = ch.doc.data();
            if(data.ts && data.ts.seconds) data.ts = data.ts.seconds * 1000;
            if(ch.type==='added') addCapsuleEntry(id, data);
            if(ch.type==='modified') updateCapsuleEntry(id, data);
            if(ch.type==='removed') removeCapsuleEntry(id);
          });
        }, err => { console.error('firestore snapshot err', err); setTimeout(createDemoCapsules,200); });
      } catch(e){
        console.error('Firebase init failed', e); setTimeout(createDemoCapsules,200);
      }
    } else {
      createDemoCapsules();
    }
  }

  // ---------- Capsule creation ----------
  function createCapsuleMesh(data){
    // rank colors
    const rank = data && data.rank ? data.rank.toString().toLowerCase() : 'common';
    let col=0x44b3ff, trim=0x0b3a55;
    if(rank.includes('special')||rank.includes('Ø®Ø§ØµØ©')){ col=0xb36aff; trim=0x2b0f3a; }
    if(rank.includes('legend')||rank.includes('Ø®Ø§Ù„Ø¯Ø©')||rank.includes('legendary')){ col=0xffd166; trim=0x3a2a00; }

    // hex prism geometry
    const geom = new THREE.CylinderGeometry(1.2,1.2,1.8,6,1,false); geom.rotateX(Math.PI/2);
    const mat = new THREE.MeshStandardMaterial({ color: col, metalness: 0.9, roughness: 0.22, emissive:0x000000, emissiveIntensity: 0.12 });

    const prism = new THREE.Mesh(geom, mat);
    const edges = new THREE.LineSegments(new THREE.EdgesGeometry(geom), new THREE.LineBasicMaterial({ color:0x000000, transparent:true, opacity:0.12 }));

    // engraved plate pattern via canvas texture
    const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 256;
    const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,256,256);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 2;
    for(let i=0;i<6;i++){ ctx.strokeRect(18+i*8,18+i*8,220-i*16,220-i*16); }
    // add small emblem
    ctx.fillStyle = 'rgba(255,255,255,0.08)'; ctx.font = 'bold 28px sans-serif'; ctx.textAlign='center'; ctx.fillText('â—Š',128,140);
    const tex = new THREE.CanvasTexture(canvas); tex.encoding = THREE.sRGBEncoding;

    const plate = new THREE.Mesh(new THREE.CircleGeometry(0.52, 32), new THREE.MeshStandardMaterial({ map: tex, metalness:0.6, roughness:0.25, color:0x001833, emissive:0x002233, emissiveIntensity:0.12, side: THREE.DoubleSide }));
    plate.position.set(0,0,0.95); plate.rotateX(Math.PI/2);

    // subtle glow plane
    const glow = new THREE.Mesh(new THREE.PlaneGeometry(2.6,2.6), new THREE.MeshBasicMaterial({ color: col, transparent:true, opacity:0.06, blending: THREE.AdditiveBlending }));
    glow.position.set(0,0,-0.2);

    const group = new THREE.Group(); group.add(prism); group.add(edges); group.add(plate); group.add(glow);
    group.userData = { data: data||{}, isOpen:false, baseMat: mat };
    return group;
  }

  function addCapsuleEntry(id, data){
    if(capsuleEntries.has(id)) return;
    const mesh = createCapsuleMesh(data);
    mesh.position.copy(randomPosition(isMobile()?120:180));
    mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
    mesh.scale.setScalar(THREE.MathUtils.lerp(1.0, 1.6, Math.random()));
    scene.add(mesh);
    capsuleEntries.set(id, { id, mesh, data });
  }

  function updateCapsuleEntry(id, data){
    const entry = capsuleEntries.get(id);
    if(!entry){ addCapsuleEntry(id,data); return; }
    entry.data = data; entry.mesh.userData.data = data;
  }

  function removeCapsuleEntry(id){
    const entry = capsuleEntries.get(id); if(!entry) return;
    scene.remove(entry.mesh); capsuleEntries.delete(id);
  }

  function createDemoCapsules(){
    const count = isMobile()?10:28;
    for(let i=0;i<count;i++){
      const rank = (i%7===0)? 'legend' : (i%3===0)? 'special':'common';
      const data = { title:`ÙƒØ¨Ø³ÙˆÙ„Ø© #${i+1}`, message:`Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© ${i+1} â€” Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Trox!`, username:`User${i+1}`, rank, ts: Date.now() - i*60000 };
      addCapsuleEntry('demo-'+i, data);
    }
  }

  function randomPosition(radius=150){
    const u = Math.random(), v = Math.random();
    const theta = 2*Math.PI*u; const phi = Math.acos(2*v-1);
    const r = Math.cbrt(Math.random())*radius;
    const x = r*Math.sin(phi)*Math.cos(theta), y = r*Math.sin(phi)*Math.sin(theta), z = r*Math.cos(phi);
    return new THREE.Vector3(x,y,z);
  }

  // ---------- Interaction: split open + particles + sound ----------
  function onPointerDown(ev){
    ev.preventDefault();
    const rect = renderer.domElement.getBoundingClientRect();
    const clientX = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX);
    const clientY = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY);
    if(clientX === undefined) return;
    const x = ((clientX - rect.left) / rect.width) * 2 - 1;
    const y = -((clientY - rect.top) / rect.height) * 2 + 1;
    mouse.set(x,y); raycaster.setFromCamera(mouse, camera);
    const objects = []; capsuleEntries.forEach(v=> objects.push(v.mesh));
    const hits = raycaster.intersectObjects(objects, true);
    if(hits.length>0){
      let obj = hits[0].object;
      while(obj && !Array.from(capsuleEntries.values()).some(v=>v.mesh===obj)) obj = obj.parent;
      const entry = Array.from(capsuleEntries.values()).find(v=>v.mesh===obj);
      if(entry) splitOpenCapsule(entry);
    }
  }

  // WebAudio short open sound
  function playOpenSound(){
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = 520;
      o.connect(g); g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.08, now+0.02);
      o.start(now); o.frequency.exponentialRampToValueAtTime(260, now+0.2);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
      setTimeout(()=>{ o.stop(); ctx.close(); }, 700);
    } catch(e){}
  }

  // split open animation: clone halves -> animate -> particles -> overlay -> reassemble
  function splitOpenCapsule(entry){
    const g = entry.mesh; if(g.userData.isOpen) return; g.userData.isOpen = true;
    const orig = g;
    // clones as halves
    const left = orig.clone(true), right = orig.clone(true);
    left.position.copy(orig.position); left.quaternion.copy(orig.quaternion); left.scale.copy(orig.scale);
    right.position.copy(orig.position); right.quaternion.copy(orig.quaternion); right.scale.copy(orig.scale);
    scene.add(left); scene.add(right);
    scene.remove(orig);

    playOpenSound();
    particleFlash(left.position, 30, entry.data && entry.data.rank);

    const start = performance.now(), dur = 420;
    function animateSplit(t){
      const p = Math.min(1,(t-start)/dur); const ease = 1 - Math.pow(1-p,3);
      const sep = new THREE.Vector3(1,0,0).applyQuaternion(left.quaternion).multiplyScalar(2.2 * ease * (1 + (left.scale.x-1)*0.3));
      left.position.copy(orig.position).add(sep.clone().multiplyScalar(-1));
      right.position.copy(orig.position).add(sep.clone());
      left.rotation.x += 0.02*(1+ease); right.rotation.x -= 0.02*(1+ease);
      // emissive
      left.children[0].material.emissiveIntensity = 0.9*ease; right.children[0].material.emissiveIntensity = 0.9*ease;
      if(p<1) requestAnimationFrame(animateSplit);
      else {
        showOverlay(entry);
        setTimeout(()=> {
          // reassemble
          const s2 = performance.now(), d2 = 380;
          function reasm(t2){
            const q = Math.min(1,(t2-s2)/d2); const e2 = 1 - Math.pow(1-q,3);
            const sepNow = sep.clone().multiplyScalar(1-e2);
            left.position.copy(orig.position).add(sepNow.clone().multiplyScalar(-1));
            right.position.copy(orig.position).add(sepNow);
            left.children[0].material.emissiveIntensity = 0.9*(1-e2);
            right.children[0].material.emissiveIntensity = 0.9*(1-e2);
            if(q<1) requestAnimationFrame(reasm);
            else {
              scene.remove(left); scene.remove(right);
              orig.userData.isOpen = false;
              if(orig.userData.baseMat) orig.userData.baseMat.emissiveIntensity = 0.12;
              scene.add(orig);
              hideOverlay();
            }
          }
          requestAnimationFrame(reasm);
        }, 5000);
      }
    }
    requestAnimationFrame(animateSplit);
  }

  // particle flash
  function particleFlash(center, amount=24, rank){
    for(let i=0;i<amount;i++){
      const g = new THREE.SphereGeometry(0.04 + Math.random()*0.14, 6, 6);
      const color = (rank && rank.toString().toLowerCase().includes('legend')) ? 0xffd166 : (rank && rank.toString().toLowerCase().includes('special') ? 0xb36aff : 0x44b3ff);
      const mat = new THREE.MeshBasicMaterial({ color, transparent:true, opacity:1, blending: THREE.AdditiveBlending });
      const p = new THREE.Mesh(g, mat);
      p.position.copy(center);
      p.userData = { vel: new THREE.Vector3((Math.random()-0.5)*2.2, (Math.random()-0.5)*2.2, (Math.random()-0.5)*2.2), life:0 };
      scene.add(p); transientParticles.push(p);
    }
  }

  function updateParticles(dt){
    for(let i=transientParticles.length-1;i>=0;i--){
      const p = transientParticles[i];
      p.position.addScaledVector(p.userData.vel, dt);
      p.userData.life += dt;
      p.material.opacity = Math.max(0, 1 - p.userData.life*1.2);
      if(p.userData.life > 1.2){ scene.remove(p); transientParticles.splice(i,1); }
    }
  }

  function showOverlay(entry){
    const d = entry.data || entry.mesh.userData.data || {};
    ovTitle.textContent = d.title || 'ÙƒØ¨Ø³ÙˆÙ„Ø© Ø®Ø§Ù„Ø¯Ø©';
    const dateStr = d.ts ? new Date(d.ts).toLocaleString('ar-EG') : '';
    ovMeta.textContent = `${d.username||'Ù…Ø¬Ù‡ÙˆÙ„'} â€¢ ${d.rank||'Ø¹Ø§Ø¯ÙŠØ©'} â€¢ ${dateStr}`;
    ovBody.textContent = d.message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø©';
    overlay.style.display = 'block';
  }
  function hideOverlay(){ overlay.style.display = 'none'; }

  // ---------- animation loop ----------
  function animate(){
    requestAnimationFrame(animate);
    const now = performance.now(); const dt = (now - prevTime)/1000; prevTime = now;

    // capsule floating
    capsuleEntries.forEach(entry => {
      const m = entry.mesh;
      m.userData._float = m.userData._float || { t: Math.random()*100 };
      m.userData._float.t += dt * 0.45 * (0.6 + (m.scale.x-1)*0.3);
      m.position.y += Math.sin(m.userData._float.t) * 0.02;
      m.rotation.y += 0.0012 * (0.8 + (m.scale.x-1)*0.6);
    });

    updateParticles(dt);
    controls.update();
    renderer.render(scene, camera);
  }

  function onResize(){ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

  // pointer binding
  renderer && renderer.domElement && renderer.domElement.addEventListener('pointerdown', onPointerDown, {passive:false});
  renderer && renderer.domElement && renderer.domElement.addEventListener('touchstart', onPointerDown, {passive:false});

  // ---------- Auth UI ----------
  openLoginBtn.addEventListener('click', ()=> { loginModal.style.display = 'block'; });
  ovClose.addEventListener('click', hideOverlay);

  btnRegister.addEventListener('click', async ()=>{
    if(!FIREBASE_ENABLED){ alert('Firebase ØºÙŠØ± Ù…ÙØ¹Ù„ Ø§Ù„Ø¢Ù†'); return; }
    const email = document.getElementById('email').value.trim(); const pass = document.getElementById('password').value;
    if(!email || !pass){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
    try { const auth = getAuth(); await createUserWithEmailAndPassword(auth, email, pass); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'); loginModal.style.display='none'; }
    catch(err){ alert('Ø®Ø·Ø£: '+err.message); }
  });

  btnSignIn.addEventListener('click', async ()=>{
    if(!FIREBASE_ENABLED){ alert('Firebase ØºÙŠØ± Ù…ÙØ¹Ù„ Ø§Ù„Ø¢Ù†'); return; }
    const email = document.getElementById('email').value.trim(); const pass = document.getElementById('password').value;
    if(!email || !pass){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
    try { const auth = getAuth(); await signInWithEmailAndPassword(auth, email, pass); alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); loginModal.style.display='none'; }
    catch(err){ alert('Ø®Ø·Ø£: '+err.message); }
  });

  // cleanup
  window.addEventListener('beforeunload', ()=>{ try{ renderer.dispose(); }catch(e){} });

  </script>
</body>
</html>
